<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Tennis Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1a1a2e;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: 'Courier New', monospace;
      color: #eee;
    }
    h1 {
      font-size: 2rem;
      letter-spacing: 0.3em;
      margin-bottom: 12px;
      color: #f0c040;
      text-shadow: 0 0 10px #f0c04088;
    }
    #info {
      font-size: 0.85rem;
      color: #aaa;
      margin-bottom: 16px;
      letter-spacing: 0.1em;
    }
    canvas {
      background: #16213e;
      border: 3px solid #f0c040;
      border-radius: 4px;
      box-shadow: 0 0 30px #f0c04044;
      max-width: 100%;
      touch-action: none;
    }
    #touch-controls {
      display: none;
      margin-top: 12px;
      gap: 16px;
    }
    @media (pointer: coarse) {
      #touch-controls { display: flex; }
    }
    .touch-btn {
      background: rgba(240,192,64,0.2);
      border: 2px solid #f0c040;
      color: #f0c040;
      font-size: 2rem;
      width: 70px;
      height: 70px;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }
    .touch-btn:active {
      background: rgba(240,192,64,0.4);
    }
    #message {
      margin-top: 14px;
      font-size: 1rem;
      color: #f0c040;
      letter-spacing: 0.15em;
      min-height: 1.4em;
    }
  </style>
</head>
<body>
  <h1>TENNIS</h1>
  <div id="info">ãƒã‚¦ã‚¹: è‡ªç”±ç§»å‹• &nbsp;|&nbsp; W/A/S/Dãƒ»çŸ¢å°ã‚­ãƒ¼: ç§»å‹• &nbsp;|&nbsp; SPACE: ã‚¹ã‚¿ãƒ¼ãƒˆ &nbsp;|&nbsp; æ•°å­—ã‚­ãƒ¼ 1ã€œ0: ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ &nbsp;|&nbsp; ã‚¿ãƒƒãƒ: ç”»é¢ã‚’ãªãã‚‹</div>
  <canvas id="court" width="800" height="500"></canvas>
  <div id="message">SPACE ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã¯ã‚¿ãƒƒãƒ—ï¼‰</div>
  <div id="touch-controls">
    <div class="touch-btn" id="btn-up">â–²</div>
    <div class="touch-btn" id="btn-down">â–¼</div>
  </div>

  <script>
    const canvas = document.getElementById('court');
    const ctx = canvas.getContext('2d');
    const msg = document.getElementById('message');

    const W = canvas.width;
    const H = canvas.height;

    // --- ã‚²ãƒ¼ãƒ è¨­å®š ---
    const PADDLE_W = 14;
    const PADDLE_H = 90;
    const BALL_R = 9;
    const PADDLE_SPEED = 6;
    const WIN_SCORE = 7;
    const NET_W = 4;
    const SPECIAL_ZONE_RATIO = 0.18; // ç‰¹æ®Šã‚¾ãƒ¼ãƒ³ã®å‰²åˆï¼ˆç«¯ãƒ»ä¸­å¤®ï¼‰
    const FLASH_DURATION = 15;       // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æŒç¶šãƒ•ãƒ¬ãƒ¼ãƒ æ•°

    // --- ã‚¹ãƒ†ãƒ¼ã‚¸å®šç¾© ---
    const OPPONENTS = [
      { name: 'ãƒã‚ºãƒŸ',   emoji: 'ğŸ­', color: '#ccc',  speed: 2.5,  freedom: 0,    hp: 15 },
      { name: 'çŒ«',       emoji: 'ğŸ±', color: '#faa',  speed: 3.2,  freedom: 0,    hp: 20 },
      { name: 'å¤§å‹çŠ¬',   emoji: 'ğŸ•', color: '#ca7',  speed: 4.0,  freedom: 0,    hp: 25 },
      { name: 'ã‚¤ãƒã‚·ã‚·', emoji: 'ğŸ—', color: '#b97',  speed: 4.8,  freedom: 0.2,  hp: 30 },
      { name: 'ãƒ ãƒ¼ã‚¹',   emoji: 'ğŸ«', color: '#8c6',  speed: 5.5,  freedom: 0.4,  hp: 35 },
      { name: 'è™',       emoji: 'ğŸ¯', color: '#fb4',  speed: 6.2,  freedom: 0.55, hp: 40 },
      { name: 'ãƒ©ã‚¤ã‚ªãƒ³', emoji: 'ğŸ¦', color: '#e84',  speed: 7.0,  freedom: 0.65, hp: 45 },
      { name: 'ã‚¾ã‚¦',     emoji: 'ğŸ˜', color: '#aaa',  speed: 7.8,  freedom: 0.75, hp: 50 },
      { name: 'T-REX',    emoji: 'ğŸ¦–', color: '#5c9',  speed: 9.0,  freedom: 0.88, hp: 55 },
      { name: 'å®‡å®™äºº',   emoji: 'ğŸ‘½', color: '#8f8',  speed: 11.0, freedom: 1.0,  hp: 60 },
    ];

    // --- çŠ¶æ…‹ ---
    let state = 'idle'; // idle | playing | point | stageclear | allclear | gameover
    let keys = {};
    let currentStage = 0;

    let player, cpu, ball, scores;
    let hitParticles = [];
    let paddleFlashTimer = 0;
    let paddleFlashType = null; // 'edge' | 'center'
    let ballGlowTimer = 0;
    let ballGlowType = null;
    let ballScale = 1.0;
    let preboostSpeed = null; // ç‰¹æ®Šãƒ’ãƒƒãƒˆå‰ã®é€Ÿåº¦ï¼ˆCPUè¿”çƒæ™‚ã«ãƒªã‚»ãƒƒãƒˆç”¨ï¼‰
    let cpuMaxHp = 0;
    let cpuHp = 0;
    let cpuDestroyedTimer = 0; // ç ´å£ŠçŠ¶æ…‹ã®æ®‹ã‚Šãƒ•ãƒ¬ãƒ¼ãƒ æ•°ï¼ˆ60fps Ã— 3ç§’ = 180ï¼‰
    let cpuDamageFlash = 0;   // ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã®æ®‹ã‚Šãƒ•ãƒ¬ãƒ¼ãƒ æ•°
    let confetti = [];        // èŠ±å¹é›ªãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«

    function initCpuHp() {
      cpuMaxHp = OPPONENTS[currentStage].hp;
      cpuHp = cpuMaxHp;
    }

    function resetGame() {
      currentStage = 0;
      scores = { player: 0, cpu: 0 };
      confetti = [];
      initCpuHp();
      resetRound(null);
      state = 'idle';
      msg.textContent = 'SPACE ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ';
    }

    function resetRound(scorer) {
      player = { x: 20, y: H / 2 - PADDLE_H / 2, w: PADDLE_W, h: PADDLE_H, dy: 0 };
      cpu    = { x: W - 20 - PADDLE_W, y: H / 2 - PADDLE_H / 2, w: PADDLE_W, h: PADDLE_H, dy: 0 };

      const dir = scorer === 'cpu' ? 1 : -1; // ã‚µãƒ¼ãƒ–æ–¹å‘
      const angle = (Math.random() * 0.6 - 0.3); // Â±0.3 rad
      const speed = 5.5;
      ball = {
        x: W / 2, y: H / 2,
        vx: dir * speed * Math.cos(angle),
        vy: speed * Math.sin(angle),
        trail: []
      };
      hitParticles = [];
      paddleFlashTimer = 0;
      paddleFlashType = null;
      ballGlowTimer = 0;
      ballGlowType = null;
      ballScale = 1.0;
      preboostSpeed = null;
      cpuDestroyedTimer = 0; // å¾—ç‚¹ã§ãƒ©ã‚¦ãƒ³ãƒ‰ãƒªã‚»ãƒƒãƒˆæ™‚ã¯ç ´å£ŠçŠ¶æ…‹ã‚’è§£é™¤
      cpuDamageFlash = 0;
      // â€» cpuHp ã¯ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ã¾ãŸã„ã§å¼•ãç¶™ãï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆæ™‚ã®ã¿å¾©å…ƒï¼‰
    }

    // --- ç‰¹æ®Šã‚¾ãƒ¼ãƒ³åˆ¤å®š ---
    function checkSpecialZone(ballY, paddle) {
      const rel = (ballY - (paddle.y + PADDLE_H / 2)) / (PADDLE_H / 2);
      if (Math.abs(rel) > 1 - SPECIAL_ZONE_RATIO) return 'edge';
      if (Math.abs(rel) < SPECIAL_ZONE_RATIO) return 'center';
      return null;
    }

    // --- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆ ---
    function spawnHitParticles(x, y, type) {
      const color  = type === 'edge' ? '#ff6633' : '#33ccff';
      const spark  = type === 'edge' ? '#ffaa44' : '#88eeff';
      const count = 20;
      for (let i = 0; i < count; i++) {
        const angle = (i / count) * Math.PI * 2 + (Math.random() - 0.5) * 0.6;
        const speed = 2.5 + Math.random() * 6;
        hitParticles.push({
          x, y,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          life: 1.0,
          decay: 0.035 + Math.random() * 0.025,
          color: Math.random() < 0.5 ? color : spark,
          size: 1.5 + Math.random() * 2.5
        });
      }
    }

    // --- ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥èƒŒæ™¯ ---
    function drawStageBackground(stage) {
      const T = performance.now() / 1000;
      ctx.save();
      switch (stage) {

        // 0: ãƒã‚ºãƒŸ - è·¯åœ°è£ï¼ˆå¤œï¼‰
        case 0: {
          ctx.fillStyle = '#0d0b18'; ctx.fillRect(0, 0, W, H);
          // ãƒ¬ãƒ³ã‚¬å£
          for (const [x0, x1] of [[0, W/2-4], [W/2+4, W]]) {
            ctx.fillStyle = '#2c1a12'; ctx.fillRect(x0, 0, x1-x0, H*0.7);
            ctx.strokeStyle = '#1a0e0a'; ctx.lineWidth = 1;
            for (let y = 0; y < H*0.7; y += 16) {
              const off = Math.floor(y/16) % 2 * 28;
              for (let x = x0+off; x < x1; x += 56) ctx.strokeRect(x+1,y+1,54,14);
            }
          }
          // æ¿¡ã‚ŒãŸã‚¢ã‚¹ãƒ•ã‚¡ãƒ«ãƒˆ
          const gG = ctx.createLinearGradient(0,H*0.7,0,H);
          gG.addColorStop(0,'#1c1c1c'); gG.addColorStop(1,'#111');
          ctx.fillStyle = gG; ctx.fillRect(0,H*0.7,W,H*0.3);
          // æ°´ãŸã¾ã‚Š
          ctx.fillStyle = 'rgba(55,75,140,0.38)';
          ctx.beginPath(); ctx.ellipse(W*0.25,H*0.84,55,10,0,0,Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.ellipse(W*0.72,H*0.88,38,7,0,0,Math.PI*2); ctx.fill();
          // è¡—ç¯
          ctx.strokeStyle = '#555'; ctx.lineWidth = 3;
          ctx.beginPath(); ctx.moveTo(W*0.1,H*0.7); ctx.lineTo(W*0.1,H*0.1); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(W*0.1,H*0.1); ctx.lineTo(W*0.18,H*0.06); ctx.stroke();
          const lG = ctx.createRadialGradient(W*0.18,H*0.06,3,W*0.18,H*0.06,90);
          lG.addColorStop(0,'rgba(255,230,100,0.32)'); lG.addColorStop(1,'rgba(255,230,100,0)');
          ctx.fillStyle = lG; ctx.fillRect(0,0,W/2,H*0.5);
          ctx.fillStyle = '#ffe080'; ctx.beginPath(); ctx.arc(W*0.18,H*0.06,4,0,Math.PI*2); ctx.fill();
          // ã‚´ãƒŸç®±
          ctx.fillStyle = '#404040'; ctx.fillRect(W*0.76,H*0.52,20,28);
          ctx.fillStyle = '#333';    ctx.fillRect(W*0.74,H*0.50,24,5);
          ctx.fillStyle = '#4a4a4a'; ctx.fillRect(W*0.83,H*0.56,16,22);
          ctx.fillStyle = '#383838'; ctx.fillRect(W*0.815,H*0.54,20,4);
          // ã‚´ãƒŸè¢‹
          ctx.fillStyle = '#181818';
          ctx.beginPath(); ctx.ellipse(W*0.73,H*0.70,13,16,-0.2,0,Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.ellipse(W*0.79,H*0.72,10,13,0.3,0,Math.PI*2); ctx.fill();
          break;
        }

        // 1: çŒ« - é“è·¯ç«¯ï¼ˆæ˜¼ï¼‰
        case 1: {
          const sG = ctx.createLinearGradient(0,0,0,H*0.58);
          sG.addColorStop(0,'#5ba0d8'); sG.addColorStop(1,'#b0d8f0');
          ctx.fillStyle = sG; ctx.fillRect(0,0,W,H*0.58);
          // é›²
          ctx.fillStyle = 'rgba(255,255,255,0.88)';
          for (const [cx,cy,r] of [[W*0.18,H*0.1,28],[W*0.26,H*0.08,20],[W*0.62,H*0.16,26],[W*0.69,H*0.14,18]])
            { ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); }
          // ãƒ“ãƒ«
          for (const [bx,bw,bh,bc] of [[0,55,H*0.42,'#7a8fa0'],[50,40,H*0.35,'#8a9fb0'],[W-55,50,H*0.40,'#7a8fa0'],[W-100,38,H*0.33,'#909fae']]) {
            ctx.fillStyle = bc; ctx.fillRect(bx, H*0.58-bh, bw, bh);
            ctx.fillStyle = 'rgba(200,230,255,0.55)';
            for (let wy=H*0.58-bh+8; wy<H*0.58-10; wy+=16)
              for (let wx=bx+6; wx<bx+bw-8; wx+=14) ctx.fillRect(wx,wy,8,9);
          }
          // æ­©é“
          ctx.fillStyle = '#b2b2a0'; ctx.fillRect(0,H*0.58,W,H*0.09);
          ctx.strokeStyle = '#a0a090'; ctx.lineWidth = 1;
          for (let x=0; x<W; x+=42) { ctx.beginPath(); ctx.moveTo(x,H*0.58); ctx.lineTo(x,H*0.67); ctx.stroke(); }
          // é“è·¯
          ctx.fillStyle = '#3a3a3a'; ctx.fillRect(0,H*0.67,W,H*0.33);
          ctx.strokeStyle = '#ffff00'; ctx.lineWidth = 3; ctx.setLineDash([28,18]);
          ctx.beginPath(); ctx.moveTo(0,H*0.78); ctx.lineTo(W,H*0.78); ctx.stroke();
          ctx.setLineDash([]); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
          ctx.beginPath(); ctx.moveTo(0,H*0.67); ctx.lineTo(W,H*0.67); ctx.stroke();
          // è¡—ç¯
          ctx.strokeStyle = '#666'; ctx.lineWidth = 4;
          ctx.beginPath(); ctx.moveTo(W*0.35,H*0.67); ctx.lineTo(W*0.35,H*0.2); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(W*0.35,H*0.2); ctx.lineTo(W*0.43,H*0.16); ctx.stroke();
          ctx.fillStyle = '#ffee88'; ctx.beginPath(); ctx.arc(W*0.43,H*0.16,5,0,Math.PI*2); ctx.fill();
          break;
        }

        // 2: å¤§å‹çŠ¬ - å…¬åœ’
        case 2: {
          const sG2 = ctx.createLinearGradient(0,0,0,H*0.52);
          sG2.addColorStop(0,'#4898e0'); sG2.addColorStop(1,'#9ad0ee');
          ctx.fillStyle = sG2; ctx.fillRect(0,0,W,H*0.52);
          ctx.fillStyle = 'rgba(255,255,255,0.9)';
          for (const [cx,cy,r] of [[W*0.2,H*0.1,26],[W*0.28,H*0.08,18],[W*0.65,H*0.14,24],[W*0.72,H*0.12,16]])
            { ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); }
          // èŠç”Ÿ
          const gG2 = ctx.createLinearGradient(0,H*0.52,0,H);
          gG2.addColorStop(0,'#4a9a38'); gG2.addColorStop(1,'#3a7828');
          ctx.fillStyle = gG2; ctx.fillRect(0,H*0.52,W,H*0.48);
          // ç ‚åˆ©é“
          ctx.fillStyle = '#c8b880'; ctx.fillRect(W*0.32,H*0.52,W*0.36,H*0.48);
          ctx.strokeStyle = '#b8a870'; ctx.lineWidth = 1; ctx.strokeRect(W*0.32,H*0.52,W*0.36,H*0.48);
          // ãƒ™ãƒ³ãƒ
          ctx.fillStyle = '#8b6914';
          ctx.fillRect(W*0.68,H*0.67,52,6); ctx.fillRect(W*0.68,H*0.61,52,5);
          ctx.fillRect(W*0.72,H*0.66,5,12); ctx.fillRect(W*0.89,H*0.66,5,12);
          // é æ™¯ã®æœ¨
          ctx.fillStyle = '#3a7030';
          for (const [tx,tr] of [[W*0.05,18],[W*0.12,14],[W*0.88,16],[W*0.94,20]])
            { ctx.beginPath(); ctx.arc(tx,H*0.52-tr,tr,0,Math.PI*2); ctx.fill(); }
          // æ‰‹å‰ã®æœ¨
          for (const [tx,tsz] of [[W*0.04,34],[W*0.96,30]]) {
            ctx.fillStyle = '#2d5e2a'; ctx.beginPath(); ctx.arc(tx,H*0.52-tsz*0.7,tsz,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = '#6b4c1e'; ctx.fillRect(tx-5,H*0.52-tsz*0.3,10,tsz*0.5);
          }
          break;
        }

        // 3: ã‚¤ãƒã‚·ã‚· - å±±é“
        case 3: {
          const sG3 = ctx.createLinearGradient(0,0,0,H*0.5);
          sG3.addColorStop(0,'#4a6fa5'); sG3.addColorStop(1,'#8ab0ce');
          ctx.fillStyle = sG3; ctx.fillRect(0,0,W,H*0.5);
          // å±±ï¼ˆå¥¥ã‹ã‚‰æ‰‹å‰ï¼‰
          for (const [pts,col] of [
            [[0,H*0.5,W*0.15,H*0.18,W*0.32,H*0.5],'#6888a8'],
            [[W*0.18,H*0.5,W*0.38,H*0.12,W*0.58,H*0.5],'#7a98b8'],
            [[W*0.42,H*0.5,W*0.62,H*0.2,W*0.82,H*0.5],'#8898b8'],
            [[W*0.68,H*0.5,W*0.86,H*0.16,W,H*0.5],'#7890ba']
          ]) {
            ctx.fillStyle = col; ctx.beginPath();
            ctx.moveTo(pts[0],pts[1]); ctx.lineTo(pts[2],pts[3]); ctx.lineTo(pts[4],pts[5]);
            ctx.closePath(); ctx.fill();
          }
          // æ£®
          const fG = ctx.createLinearGradient(0,H*0.5,0,H*0.72);
          fG.addColorStop(0,'#2a5520'); fG.addColorStop(1,'#1e3d18');
          ctx.fillStyle = fG; ctx.fillRect(0,H*0.5,W,H*0.22);
          // æ¾ã®æœ¨
          ctx.fillStyle = '#1a3d10';
          for (const [tx,th] of [[W*0.06,40],[W*0.13,50],[W*0.2,35],[W*0.78,44],[W*0.86,38],[W*0.93,50]]) {
            ctx.beginPath(); ctx.moveTo(tx,H*0.72-th); ctx.lineTo(tx+13,H*0.72); ctx.lineTo(tx-13,H*0.72); ctx.closePath(); ctx.fill();
            ctx.beginPath(); ctx.moveTo(tx,H*0.72-th*1.45); ctx.lineTo(tx+9,H*0.72-th*0.4); ctx.lineTo(tx-9,H*0.72-th*0.4); ctx.closePath(); ctx.fill();
          }
          // åœŸé“
          ctx.fillStyle = '#8a6a40';
          ctx.beginPath(); ctx.moveTo(W*0.36,H*0.72); ctx.lineTo(W*0.42,H); ctx.lineTo(W*0.58,H); ctx.lineTo(W*0.64,H*0.72); ctx.fill();
          const gG3 = ctx.createLinearGradient(0,H*0.72,0,H);
          gG3.addColorStop(0,'#5a7840'); gG3.addColorStop(1,'#4a6030');
          ctx.fillStyle = gG3; ctx.fillRect(0,H*0.72,W,H*0.28);
          // å²©
          ctx.fillStyle = '#808080';
          for (const [rx,ry,rw,rh] of [[W*0.2,H*0.78,20,14],[W*0.72,H*0.82,16,12],[W*0.5,H*0.9,22,15]])
            { ctx.beginPath(); ctx.ellipse(rx,ry,rw,rh,0,0,Math.PI*2); ctx.fill(); }
          break;
        }

        // 4: ãƒ ãƒ¼ã‚¹ - æ¹¿åœ°å¸¯
        case 4: {
          const sG4 = ctx.createLinearGradient(0,0,0,H*0.45);
          sG4.addColorStop(0,'#7a9090'); sG4.addColorStop(1,'#a8bfbf');
          ctx.fillStyle = sG4; ctx.fillRect(0,0,W,H*0.45);
          // é æ™¯ã®æœ¨
          ctx.fillStyle = '#3a5a4a';
          for (const [tx,tw,th] of [[0,28,H*0.18],[22,22,H*0.14],[W-28,26,H*0.16],[W-50,20,H*0.12]])
            ctx.fillRect(tx,H*0.45-th,tw,th);
          // æ°´é¢
          const wG4 = ctx.createLinearGradient(0,H*0.45,0,H);
          wG4.addColorStop(0,'#4a6a6a'); wG4.addColorStop(1,'#2a4a4a');
          ctx.fillStyle = wG4; ctx.fillRect(0,H*0.45,W,H*0.55);
          // æ°´é¢ã®æ³¢ç´‹
          ctx.strokeStyle = 'rgba(180,210,210,0.28)'; ctx.lineWidth = 1;
          for (const [rx,ry,rr] of [[W*0.2,H*0.6,32],[W*0.62,H*0.75,26],[W*0.85,H*0.55,20]])
            { ctx.beginPath(); ctx.ellipse(rx,ry,rr,rr*0.28,0,0,Math.PI*2); ctx.stroke(); }
          // ã‚¬ãƒã®ç©‚ï¼ˆè‘¦ï¼‰
          ctx.lineWidth = 3;
          for (const [rx,ry] of [[W*0.07,H*0.5],[W*0.11,H*0.48],[W*0.15,H*0.52],[W*0.78,H*0.49],[W*0.82,H*0.52],[W*0.87,H*0.47]]) {
            ctx.strokeStyle = '#6a5a30';
            ctx.beginPath(); ctx.moveTo(rx,ry+38); ctx.lineTo(rx,ry); ctx.stroke();
            ctx.fillStyle = '#4a3a20'; ctx.beginPath(); ctx.ellipse(rx,ry,4,11,0,0,Math.PI*2); ctx.fill();
          }
          // éœ§
          const mG = ctx.createLinearGradient(0,H*0.45,0,H*0.65);
          mG.addColorStop(0,'rgba(180,200,200,0.32)'); mG.addColorStop(1,'rgba(180,200,200,0)');
          ctx.fillStyle = mG; ctx.fillRect(0,H*0.45,W,H*0.28);
          break;
        }

        // 5: è™ - æš—ã„ç«¹æ—
        case 5: {
          ctx.fillStyle = '#050e07'; ctx.fillRect(0,0,W,H);
          ctx.fillStyle = '#0a180c'; ctx.fillRect(0,H*0.72,W,H*0.28);
          // æœˆå…‰
          const mG5 = ctx.createRadialGradient(W*0.74,H*0.14,5,W*0.74,H*0.14,55);
          mG5.addColorStop(0,'rgba(215,225,195,0.48)'); mG5.addColorStop(1,'rgba(215,225,195,0)');
          ctx.fillStyle = mG5; ctx.fillRect(W/2,0,W/2,H*0.4);
          ctx.fillStyle = 'rgba(215,225,190,0.55)';
          ctx.beginPath(); ctx.arc(W*0.74,H*0.14,20,0,Math.PI*2); ctx.fill();
          // ç«¹ã®å¹¹
          for (const [bx,bw,bc] of [
            [W*0.03,10,'#1a3a1a'],[W*0.09,8,'#152e15'],[W*0.15,11,'#1e401e'],[W*0.2,9,'#163016'],[W*0.27,10,'#183018'],
            [W*0.56,10,'#1a3a1a'],[W*0.63,9,'#153015'],[W*0.7,11,'#1e401e'],[W*0.77,8,'#182e18'],[W*0.84,10,'#163016'],[W*0.91,9,'#1a3a1a'],[W*0.97,8,'#152e15']
          ]) {
            ctx.fillStyle = bc; ctx.fillRect(bx-bw/2,0,bw,H);
            ctx.strokeStyle = 'rgba(0,0,0,0.35)'; ctx.lineWidth = 1;
            for (let y=H*0.12; y<H; y+=42) { ctx.beginPath(); ctx.moveTo(bx-bw/2,y); ctx.lineTo(bx+bw/2,y); ctx.stroke(); }
          }
          // å…‰ã®ç­‹
          ctx.fillStyle = 'rgba(170,210,150,0.04)';
          for (const lx of [W*0.22,W*0.48,W*0.72]) {
            ctx.beginPath(); ctx.moveTo(lx-18,0); ctx.lineTo(lx+18,0); ctx.lineTo(lx+38,H); ctx.lineTo(lx-38,H); ctx.closePath(); ctx.fill();
          }
          break;
        }

        // 6: ãƒ©ã‚¤ã‚ªãƒ³ - ã‚µãƒãƒ³ãƒŠã®è‰åŸ
        case 6: {
          const sG6 = ctx.createLinearGradient(0,0,0,H*0.6);
          sG6.addColorStop(0,'#180e58'); sG6.addColorStop(0.3,'#c03818'); sG6.addColorStop(0.7,'#f07828'); sG6.addColorStop(1,'#f0bf58');
          ctx.fillStyle = sG6; ctx.fillRect(0,0,W,H*0.6);
          // å¤ªé™½
          ctx.fillStyle = '#ffdd00'; ctx.shadowBlur = 28; ctx.shadowColor = '#ff9900';
          ctx.beginPath(); ctx.arc(W/2,H*0.56,26,0,Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;
          // åœ°å¹³ç·šã®ã‚¢ã‚«ã‚·ã‚¢ï¼ˆå½±çµµï¼‰
          ctx.fillStyle = '#130900';
          for (const [tx,tw,th] of [[W*0.08,52,H*0.38],[W*0.92,46,H*0.34]]) {
            ctx.fillRect(tx-3,H*0.6-th,6,th);
            ctx.beginPath(); ctx.ellipse(tx,H*0.6-th-6,tw/2,14,0,0,Math.PI*2); ctx.fill();
          }
          // ã‚µãƒãƒ³ãƒŠã®åœ°é¢
          const grG6 = ctx.createLinearGradient(0,H*0.6,0,H);
          grG6.addColorStop(0,'#c88820'); grG6.addColorStop(0.4,'#a07010'); grG6.addColorStop(1,'#806010');
          ctx.fillStyle = grG6; ctx.fillRect(0,H*0.6,W,H*0.4);
          // è‰ã®ç©‚å…ˆ
          ctx.strokeStyle = '#d4a030'; ctx.lineWidth = 2;
          for (let gx=8; gx<W; gx+=16) {
            const gy = H*0.6 + Math.sin(gx*0.3)*4 + 4;
            ctx.beginPath(); ctx.moveTo(gx,gy+10); ctx.lineTo(gx-4,gy); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(gx,gy+10); ctx.lineTo(gx+4,gy); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(gx,gy+10); ctx.lineTo(gx,gy-2); ctx.stroke();
          }
          // æ‰‹å‰ã‚¢ã‚«ã‚·ã‚¢ï¼ˆå½±çµµã€å·¦å³ï¼‰
          ctx.fillStyle = '#0c0600';
          for (const [tx,tw] of [[-4,80],[W+4,88]]) {
            ctx.fillRect(tx-4,H*0.6-H*0.46,8,H*0.46);
            ctx.beginPath(); ctx.ellipse(tx,H*0.6-H*0.46,tw/2,16,0,0,Math.PI*2); ctx.fill();
          }
          break;
        }

        // 7: ã‚¾ã‚¦ - ã‚µãƒãƒ³ãƒŠã®æ°´è¾º
        case 7: {
          const sG7 = ctx.createLinearGradient(0,0,0,H*0.55);
          sG7.addColorStop(0,'#280a4e'); sG7.addColorStop(0.38,'#881e8a'); sG7.addColorStop(0.8,'#e05838'); sG7.addColorStop(1,'#f09050');
          ctx.fillStyle = sG7; ctx.fillRect(0,0,W,H*0.55);
          ctx.fillStyle = '#ffcc44'; ctx.shadowBlur = 18; ctx.shadowColor = '#ff8800';
          ctx.beginPath(); ctx.arc(W/2,H*0.52,20,0,Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;
          // é æ™¯ã®æœ¨ï¼ˆå½±ï¼‰
          ctx.fillStyle = '#140800';
          for (const [tx,th] of [[W*0.05,H*0.3],[W*0.11,H*0.24],[W*0.88,H*0.27],[W*0.95,H*0.21]]) {
            ctx.fillRect(tx-4,H*0.55-th,8,th); ctx.beginPath(); ctx.ellipse(tx,H*0.55-th-4,24,10,0,0,Math.PI*2); ctx.fill();
          }
          // æ°´é¢
          const wG7 = ctx.createLinearGradient(0,H*0.55,0,H);
          wG7.addColorStop(0,'#4a2e80'); wG7.addColorStop(0.3,'#3a2870'); wG7.addColorStop(1,'#1a0e40');
          ctx.fillStyle = wG7; ctx.fillRect(0,H*0.55,W,H*0.45);
          // å¤ªé™½ã®åå°„
          const refG = ctx.createLinearGradient(0,H*0.55,0,H*0.85);
          refG.addColorStop(0,'rgba(255,200,60,0.38)'); refG.addColorStop(1,'rgba(255,200,60,0)');
          ctx.fillStyle = refG;
          ctx.beginPath(); ctx.moveTo(W*0.43,H*0.55); ctx.lineTo(W*0.57,H*0.55); ctx.lineTo(W*0.72,H*0.85); ctx.lineTo(W*0.28,H*0.85); ctx.fill();
          // æ°´å¹³ç·š
          ctx.strokeStyle = 'rgba(200,180,255,0.22)'; ctx.lineWidth = 1;
          for (let wy=H*0.58; wy<H; wy+=16) { ctx.beginPath(); ctx.moveTo(0,wy); ctx.lineTo(W,wy); ctx.stroke(); }
          // è‘¦ï¼ˆã‚¬ãƒï¼‰
          ctx.lineWidth = 2;
          for (const [rx,rh] of [[W*0.05,H*0.22],[W*0.09,H*0.17],[W*0.13,H*0.24],[W*0.82,H*0.2],[W*0.87,H*0.25],[W*0.92,H*0.18]]) {
            ctx.strokeStyle = '#3a2a10';
            ctx.beginPath(); ctx.moveTo(rx,H*0.55+rh*0.5); ctx.lineTo(rx,H*0.55-rh); ctx.stroke();
            ctx.fillStyle = '#2a1a08'; ctx.beginPath(); ctx.ellipse(rx,H*0.55-rh,3,10,0,0,Math.PI*2); ctx.fill();
          }
          break;
        }

        // 8: T-REX - å™´ç«ã™ã‚‹ç«å±±ãƒ»ã‚¸ãƒ¥ãƒ©ç´€
        case 8: {
          const sG8 = ctx.createLinearGradient(0,0,0,H*0.56);
          sG8.addColorStop(0,'#0d0400'); sG8.addColorStop(0.3,'#2a0800'); sG8.addColorStop(0.7,'#601a00'); sG8.addColorStop(1,'#8a2800');
          ctx.fillStyle = sG8; ctx.fillRect(0,0,W,H*0.56);
          // ç«å±±
          ctx.fillStyle = '#1a0800';
          ctx.beginPath(); ctx.moveTo(W*0.28,H*0.56); ctx.lineTo(W*0.46,H*0.04); ctx.lineTo(W*0.62,H*0.56); ctx.fill();
          // æº¶å²©ã‚°ãƒ­ãƒ¼
          const lvG = ctx.createRadialGradient(W*0.5,H*0.06,4,W*0.5,H*0.06,65);
          lvG.addColorStop(0,'rgba(255,120,0,0.85)'); lvG.addColorStop(0.4,'rgba(255,60,0,0.4)'); lvG.addColorStop(1,'rgba(255,0,0,0)');
          ctx.fillStyle = lvG; ctx.fillRect(W*0.28,0,W*0.44,H*0.28);
          // æº¶å²©æµ
          ctx.shadowBlur = 8; ctx.shadowColor = '#ff5000';
          ctx.strokeStyle = '#ff5500'; ctx.lineWidth = 4;
          ctx.beginPath(); ctx.moveTo(W*0.46,H*0.06); ctx.bezierCurveTo(W*0.44,H*0.2,W*0.4,H*0.36,W*0.38,H*0.56); ctx.stroke();
          ctx.lineWidth = 3;
          ctx.beginPath(); ctx.moveTo(W*0.52,H*0.07); ctx.bezierCurveTo(W*0.54,H*0.22,W*0.58,H*0.38,W*0.57,H*0.56); ctx.stroke();
          ctx.shadowBlur = 0;
          // ç°ã®ç²’å­ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
          ctx.fillStyle = 'rgba(90,70,45,0.6)';
          for (let i=0; i<20; i++) {
            const ax = W*0.28 + W*0.44*((i*0.18 + T*0.15) % 1);
            const ay = (T*55 + i*30) % (H*0.54);
            ctx.beginPath(); ctx.arc(ax,ay,i%3===0?2.5:1.5,0,Math.PI*2); ctx.fill();
          }
          // ã‚¸ãƒ¥ãƒ©ç´€ã®ã‚·ãƒ€
          ctx.fillStyle = '#0a1a06';
          for (const [fx,fd] of [[W*0.02,1],[W*0.98,-1]]) {
            for (let i=0; i<5; i++) {
              const fy = H*0.58 + i*H*0.08;
              ctx.beginPath(); ctx.moveTo(fx,fy); ctx.bezierCurveTo(fx+fd*28,fy-18,fx+fd*48,fy-8,fx+fd*58,fy-3); ctx.bezierCurveTo(fx+fd*48,fy+6,fx+fd*28,fy+10,fx,fy+4); ctx.fill();
            }
          }
          // åœ°é¢
          const gG8 = ctx.createLinearGradient(0,H*0.56,0,H);
          gG8.addColorStop(0,'#2c1000'); gG8.addColorStop(1,'#1a0800');
          ctx.fillStyle = gG8; ctx.fillRect(0,H*0.56,W,H*0.44);
          // åœ°å‰²ã‚Œï¼ˆæº¶å²©ï¼‰
          ctx.strokeStyle = '#ff4400'; ctx.lineWidth = 2; ctx.shadowBlur = 8; ctx.shadowColor = '#ff4400';
          ctx.beginPath(); ctx.moveTo(W*0.08,H); ctx.lineTo(W*0.28,H*0.74); ctx.lineTo(W*0.5,H*0.86); ctx.lineTo(W*0.72,H*0.72); ctx.lineTo(W*0.92,H); ctx.stroke();
          ctx.shadowBlur = 0;
          break;
        }

        // 9: å®‡å®™äºº - å®‡å®™ã¨UFO
        case 9: {
          ctx.fillStyle = '#000008'; ctx.fillRect(0,0,W,H);
          // æ˜Ÿï¼ˆç¬ãï¼‰
          for (let i=0; i<130; i++) {
            const sx = (i*137+59) % W, sy = (i*97+31) % H;
            const br = Math.sin(T*2.2+i)*0.5+0.5;
            const sr = i%4===0 ? 2 : 1;
            ctx.fillStyle = `rgba(255,255,255,${0.35+br*0.65})`;
            ctx.beginPath(); ctx.arc(sx,sy,sr,0,Math.PI*2); ctx.fill();
          }
          // æ˜Ÿé›²
          const nb1 = ctx.createRadialGradient(W*0.25,H*0.3,8,W*0.25,H*0.3,120);
          nb1.addColorStop(0,'rgba(100,0,180,0.18)'); nb1.addColorStop(1,'rgba(100,0,180,0)');
          ctx.fillStyle = nb1; ctx.fillRect(0,0,W,H);
          const nb2 = ctx.createRadialGradient(W*0.72,H*0.62,8,W*0.72,H*0.62,100);
          nb2.addColorStop(0,'rgba(0,80,200,0.18)'); nb2.addColorStop(1,'rgba(0,80,200,0)');
          ctx.fillStyle = nb2; ctx.fillRect(0,0,W,H);
          // æƒ‘æ˜Ÿï¼ˆå·¦å´ï¼‰
          const plG = ctx.createRadialGradient(W*0.1,H*0.35,4,W*0.1,H*0.35,34);
          plG.addColorStop(0,'#e8d080'); plG.addColorStop(0.6,'#c09038'); plG.addColorStop(1,'#806020');
          ctx.fillStyle = plG; ctx.beginPath(); ctx.arc(W*0.1,H*0.35,34,0,Math.PI*2); ctx.fill();
          ctx.strokeStyle = 'rgba(200,160,60,0.55)'; ctx.lineWidth = 4;
          ctx.beginPath(); ctx.ellipse(W*0.1,H*0.35,54,11,-0.3,0,Math.PI*2); ctx.stroke();
          // UFO
          const uCx = W*0.82, uCy = H*0.22;
          const uG = ctx.createRadialGradient(uCx,uCy,2,uCx,uCy,22);
          uG.addColorStop(0,'rgba(80,255,80,0.9)'); uG.addColorStop(1,'rgba(80,255,80,0)');
          ctx.fillStyle = uG; ctx.fillRect(uCx-44,uCy-32,88,64);
          ctx.fillStyle = '#c0c0d0'; ctx.shadowBlur = 10; ctx.shadowColor = '#66ff66';
          ctx.beginPath(); ctx.ellipse(uCx,uCy,38,11,0,0,Math.PI*2); ctx.fill();
          ctx.fillStyle = '#8888cc'; ctx.beginPath(); ctx.ellipse(uCx,uCy-5,17,13,0,0,Math.PI*2); ctx.fill();
          ctx.shadowBlur = 0;
          const bmG = ctx.createLinearGradient(0,uCy+11,0,uCy+80);
          bmG.addColorStop(0,'rgba(80,255,80,0.3)'); bmG.addColorStop(1,'rgba(80,255,80,0)');
          ctx.fillStyle = bmG;
          ctx.beginPath(); ctx.moveTo(uCx-20,uCy+11); ctx.lineTo(uCx+20,uCy+11); ctx.lineTo(uCx+42,uCy+80); ctx.lineTo(uCx-42,uCy+80); ctx.fill();
          // æµã‚Œæ˜Ÿ
          const mT = (T*0.5) % 1;
          ctx.strokeStyle = `rgba(255,255,200,${0.8*(1-mT)})`; ctx.lineWidth = 2;
          ctx.beginPath(); ctx.moveTo(W*mT,H*0.08+mT*H*0.3); ctx.lineTo(W*mT-28,H*0.08+mT*H*0.3-14); ctx.stroke();
          // å®‡å®™ã®åœ°é¢ï¼ˆã‚°ãƒªãƒƒãƒ‰ï¼‰
          const gG9 = ctx.createLinearGradient(0,H*0.76,0,H);
          gG9.addColorStop(0,'#0a0a1e'); gG9.addColorStop(1,'#050510');
          ctx.fillStyle = gG9; ctx.fillRect(0,H*0.76,W,H*0.24);
          ctx.strokeStyle = 'rgba(50,50,200,0.28)'; ctx.lineWidth = 1;
          for (let gx=0; gx<W; gx+=40) { ctx.beginPath(); ctx.moveTo(gx,H*0.76); ctx.lineTo(gx,H); ctx.stroke(); }
          for (let gy=H*0.76; gy<H; gy+=24) { ctx.beginPath(); ctx.moveTo(0,gy); ctx.lineTo(W,gy); ctx.stroke(); }
          break;
        }

        default:
          ctx.fillStyle = '#16213e'; ctx.fillRect(0,0,W,H);
      }
      ctx.restore();
    }

    // --- æç”» ---
    function draw() {
      ctx.clearRect(0, 0, W, H);

      // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥èƒŒæ™¯
      drawStageBackground(currentStage);

      // ã‚³ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³
      drawCourtLines();

      // ãƒãƒƒãƒˆ
      drawNet();

      // æ•µã‚­ãƒ£ãƒ©è¡¨ç¤ºï¼ˆèƒŒæ™¯ï¼‰
      drawOpponent();

      // ãƒœãƒ¼ãƒ«ã®è»Œè·¡
      drawTrail();

      // ãƒ’ãƒƒãƒˆãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
      drawHitParticles();

      // ãƒ‘ãƒ‰ãƒ«
      drawPaddle(player, '#4ecdc4', true);
      drawPaddle(cpu, OPPONENTS[currentStage].color, false);

      // CPU ç ´å£Šã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
      drawCpuDestroyedOverlay();

      // ãƒœãƒ¼ãƒ«
      drawBall();

      // ã‚¹ã‚³ã‚¢
      drawScore();
    }

    function drawCourtLines() {
      ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      ctx.lineWidth = 2;
      // å¤–æ 
      ctx.strokeRect(10, 10, W - 20, H - 20);
      // ã‚»ãƒ³ã‚¿ãƒ¼ãƒ©ã‚¤ãƒ³ï¼ˆä¸Šä¸‹ï¼‰
      ctx.beginPath();
      ctx.moveTo(W / 2, 10);
      ctx.lineTo(W / 2, H - 10);
      ctx.stroke();
    }

    function drawNet() {
      const x = W / 2 - NET_W / 2;
      const dashH = 16;
      const gap = 8;
      ctx.fillStyle = 'rgba(240,192,64,0.55)';
      for (let y = 10; y < H - 10; y += dashH + gap) {
        ctx.fillRect(x, y, NET_W, Math.min(dashH, H - 10 - y));
      }
    }

    function drawTrail() {
      ball.trail.forEach((p, i) => {
        const alpha = (i / ball.trail.length) * 0.4;
        const r = BALL_R * (i / ball.trail.length);
        ctx.beginPath();
        ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255,220,80,${alpha})`;
        ctx.fill();
      });
    }

    function drawZoneMarkers(p) {
      const zoneH = PADDLE_H * SPECIAL_ZONE_RATIO;
      ctx.save();
      ctx.beginPath();
      ctx.roundRect(p.x, p.y, p.w, p.h, 6);
      ctx.clip();
      const rx = p.x + p.w - 3;
      // ä¸Šç«¯ã‚¾ãƒ¼ãƒ³ï¼ˆæ©™ï¼‰
      ctx.fillStyle = 'rgba(255, 100, 50, 0.85)';
      ctx.fillRect(rx, p.y, 3, zoneH);
      // ä¸­å¤®ã‚¾ãƒ¼ãƒ³ï¼ˆã‚·ã‚¢ãƒ³ï¼‰
      const cy = p.y + PADDLE_H / 2 - zoneH / 2;
      ctx.fillStyle = 'rgba(50, 200, 255, 0.85)';
      ctx.fillRect(rx, cy, 3, zoneH);
      // ä¸‹ç«¯ã‚¾ãƒ¼ãƒ³ï¼ˆæ©™ï¼‰
      ctx.fillStyle = 'rgba(255, 100, 50, 0.85)';
      ctx.fillRect(rx, p.y + PADDLE_H - zoneH, 3, zoneH);
      ctx.restore();
    }

    function drawPaddle(p, color, isPlayer) {
      const radius = 6;

      // CPU ç ´å£ŠçŠ¶æ…‹: ãƒ•ãƒªãƒƒã‚«ãƒ¼è¡¨ç¤º
      if (!isPlayer && cpuDestroyedTimer > 0) {
        if (Math.floor(cpuDestroyedTimer / 5) % 2 === 0) {
          ctx.shadowBlur = 0;
          return; // ãƒ•ãƒªãƒƒã‚«ãƒ¼OFF ãƒ•ãƒ¬ãƒ¼ãƒ 
        }
        ctx.beginPath();
        ctx.roundRect(p.x, p.y, p.w, p.h, radius);
        ctx.fillStyle = '#555';
        ctx.globalAlpha = 0.55;
        ctx.shadowBlur = 18;
        ctx.shadowColor = '#ff3333';
        ctx.fill();
        ctx.globalAlpha = 1;
        ctx.shadowBlur = 0;
        return;
      }

      if (isPlayer) drawZoneMarkers(p);

      ctx.beginPath();
      ctx.roundRect(p.x, p.y, p.w, p.h, radius);
      ctx.fillStyle = color;
      ctx.shadowBlur = 12;
      ctx.shadowColor = color;
      ctx.fill();

      // CPU ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆèµ¤ï¼‰
      if (!isPlayer && cpuDamageFlash > 0) {
        const t = cpuDamageFlash / 14;
        ctx.beginPath();
        ctx.roundRect(p.x, p.y, p.w, p.h, radius);
        ctx.fillStyle = `rgba(255,50,50,${t * 0.85})`;
        ctx.shadowBlur = 22 * t;
        ctx.shadowColor = '#ff2222';
        ctx.fill();
      }

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ç‰¹æ®Šãƒ’ãƒƒãƒˆ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
      if (isPlayer && paddleFlashTimer > 0) {
        const t = paddleFlashTimer / FLASH_DURATION;
        const flashColor = paddleFlashType === 'edge' ? '#ff6633' : '#33ccff';
        ctx.beginPath();
        ctx.roundRect(p.x, p.y, p.w, p.h, radius);
        ctx.fillStyle = `rgba(255,255,255,${t * 0.85})`;
        ctx.shadowBlur = 45 * t;
        ctx.shadowColor = flashColor;
        ctx.fill();
      }
      ctx.shadowBlur = 0;
    }

    function drawCpuDestroyedOverlay() {
      if (cpuDestroyedTimer <= 0) return;
      const secs = Math.ceil(cpuDestroyedTimer / 60);
      const cx = cpu.x + PADDLE_W / 2;
      ctx.save();
      ctx.font = 'bold 13px Courier New';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#ff4444';
      ctx.shadowBlur = 10;
      ctx.shadowColor = '#ff4444';
      ctx.fillText(`ğŸ’¥ ${secs}ç§’`, cx, cpu.y - 10);
      ctx.restore();
    }

    function drawHitParticles() {
      hitParticles.forEach(p => {
        const r = p.size * Math.sqrt(p.life);
        ctx.beginPath();
        ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life * p.life;
        ctx.shadowBlur = 8;
        ctx.shadowColor = p.color;
        ctx.fill();
      });
      ctx.globalAlpha = 1;
      ctx.shadowBlur = 0;
    }

    function drawBall() {
      const r = BALL_R * ballScale;
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, r, 0, Math.PI * 2);
      const grad = ctx.createRadialGradient(ball.x - 3, ball.y - 3, 1, ball.x, ball.y, r);
      grad.addColorStop(0, '#fffbe0');
      grad.addColorStop(1, '#f0c040');
      ctx.fillStyle = grad;
      if (ballGlowTimer > 0) {
        const t = ballGlowTimer / 30;
        ctx.shadowBlur = 16 + 36 * t;
        ctx.shadowColor = ballGlowType === 'edge' ? '#ff6633' : '#33ccff';
      } else {
        ctx.shadowBlur = 16;
        ctx.shadowColor = '#f0c040';
      }
      ctx.fill();
      ctx.shadowBlur = 0;
    }

    function drawScore() {
      const opp = OPPONENTS[currentStage];

      // ã‚¹ãƒ†ãƒ¼ã‚¸ç•ªå·ï¼ˆä¸­å¤®ä¸Šéƒ¨ï¼‰
      ctx.font = 'bold 13px Courier New';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#f0c040';
      ctx.fillText(`STAGE  ${currentStage + 1} / ${OPPONENTS.length}`, W / 2, 22);

      // ã‚¹ã‚³ã‚¢æ•°å­—
      ctx.font = 'bold 48px Courier New';
      ctx.fillStyle = 'rgba(255,255,255,0.15)';
      ctx.fillText(scores.player, W / 4, 70);
      ctx.fillText(scores.cpu,    W * 3 / 4, 70);

      ctx.fillStyle = '#fff';
      ctx.fillText(scores.player, W / 4, 68);
      ctx.fillText(scores.cpu,    W * 3 / 4, 68);

      // ãƒ©ãƒ™ãƒ«
      ctx.font = '13px Courier New';
      ctx.fillStyle = '#4ecdc4';
      ctx.fillText('PLAYER', W / 4, 90);
      ctx.fillStyle = opp.color;
      ctx.fillText(opp.name, W * 3 / 4, 90);

      // CPU HP ãƒãƒ¼
      if (cpuMaxHp > 0) {
        const hpRatio = cpuHp / cpuMaxHp;
        const barW = 88;
        const barH = 6;
        const barX = W * 3 / 4 - barW / 2;
        const barY = 97;
        // èƒŒæ™¯
        ctx.fillStyle = 'rgba(255,255,255,0.12)';
        ctx.fillRect(barX, barY, barW, barH);
        // HPæœ¬ä½“
        if (hpRatio > 0) {
          const hpColor = hpRatio > 0.5 ? '#44ee66' : hpRatio > 0.25 ? '#ffcc33' : '#ff4444';
          ctx.fillStyle = hpColor;
          ctx.shadowBlur = cpuDamageFlash > 0 ? 10 : 4;
          ctx.shadowColor = hpColor;
          ctx.fillRect(barX, barY, barW * hpRatio, barH);
          ctx.shadowBlur = 0;
        }
        // HP ãƒ©ãƒ™ãƒ«
        ctx.font = '10px Courier New';
        ctx.textAlign = 'center';
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.fillText(`HP  ${cpuHp} / ${cpuMaxHp}`, W * 3 / 4, barY + barH + 11);
      }
    }

    function drawOpponent() {
      const opp = OPPONENTS[currentStage];
      // å³åŠã‚³ãƒ¼ãƒˆã«å¤§ããªçµµæ–‡å­—ã‚’åŠé€æ˜ã§è¡¨ç¤º
      ctx.save();
      ctx.font = '110px serif';
      ctx.textAlign = 'center';
      ctx.globalAlpha = 0.38;
      ctx.fillStyle = '#fff';
      ctx.fillText(opp.emoji, W * 3 / 4, H / 2 + 45);
      ctx.globalAlpha = 1;
      ctx.restore();
    }

    // --- æ›´æ–° ---
    function update() {
      if (state !== 'playing') return;

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼‰
      if (keys['w'] || keys['W'] || keys['ArrowUp']) {
        player.y -= PADDLE_SPEED;
      }
      if (keys['s'] || keys['S'] || keys['ArrowDown']) {
        player.y += PADDLE_SPEED;
      }
      if (keys['a'] || keys['A'] || keys['ArrowLeft']) {
        player.x -= PADDLE_SPEED;
      }
      if (keys['d'] || keys['D'] || keys['ArrowRight']) {
        player.x += PADDLE_SPEED;
      }
      // ã‚¿ãƒƒãƒæ“ä½œ: æŒ‡ã®ä½ç½®ã«ãƒ‘ãƒ‰ãƒ«ä¸­å¿ƒã‚’è¿½å¾“
      if (touchPos !== null) {
        const targetX = touchPos.x - PADDLE_W / 2;
        const targetY = touchPos.y - PADDLE_H / 2;
        player.x += clamp(targetX - player.x, -PADDLE_SPEED * 2, PADDLE_SPEED * 2);
        player.y += clamp(targetY - player.y, -PADDLE_SPEED * 2, PADDLE_SPEED * 2);
      }
      // å·¦åŠã‚³ãƒ¼ãƒˆå†…ã«åˆ¶é™
      player.x = clamp(player.x, 5, W / 2 - PADDLE_W);
      player.y = clamp(player.y, 0, H - PADDLE_H);

      // CPU AIï¼ˆç ´å£Šä¸­ã¯å‹•ã‘ãªã„ï¼‰
      const opp = OPPONENTS[currentStage];
      if (cpuDestroyedTimer === 0) {
        const cpuCenterY = cpu.y + PADDLE_H / 2;
        const dyDiff = ball.y - cpuCenterY;
        const vertSpeed = Math.min(Math.abs(dyDiff), opp.speed);
        cpu.y += Math.sign(dyDiff) * vertSpeed;
        cpu.y = clamp(cpu.y, 0, H - PADDLE_H);

        // æ¨ªç§»å‹•ï¼ˆfreedom > 0 ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã¿ï¼‰
        if (opp.freedom > 0) {
          const baseX = W - 20 - PADDLE_W;
          const targetX = ball.vx > 0
            ? clamp(ball.x - PADDLE_W * 3, W / 2, baseX)
            : baseX;
          const hdiff = targetX - cpu.x;
          const horizSpeed = opp.freedom * opp.speed * 0.5;
          cpu.x += clamp(hdiff, -horizSpeed, horizSpeed);
          cpu.x = clamp(cpu.x, W / 2, W - PADDLE_W - 5);
        }
      }

      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ãƒ»ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
      for (let i = hitParticles.length - 1; i >= 0; i--) {
        const p = hitParticles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.vx *= 0.9;
        p.vy *= 0.9;
        p.life -= p.decay;
        if (p.life <= 0) hitParticles.splice(i, 1);
      }
      if (paddleFlashTimer > 0) paddleFlashTimer--;
      if (ballGlowTimer > 0) ballGlowTimer--;
      if (ballScale > 1.0) ballScale = Math.max(1.0, ballScale - 0.055);
      if (cpuDestroyedTimer > 0) cpuDestroyedTimer--;
      if (cpuDamageFlash > 0) cpuDamageFlash--;

      // ãƒœãƒ¼ãƒ«è»Œè·¡
      ball.trail.push({ x: ball.x, y: ball.y });
      if (ball.trail.length > 10) ball.trail.shift();

      // ãƒœãƒ¼ãƒ«ç§»å‹•
      ball.x += ball.vx;
      ball.y += ball.vy;

      // ä¸Šä¸‹å£åå°„
      if (ball.y - BALL_R < 0) {
        ball.y = BALL_R;
        ball.vy = Math.abs(ball.vy);
      }
      if (ball.y + BALL_R > H) {
        ball.y = H - BALL_R;
        ball.vy = -Math.abs(ball.vy);
      }

      // ãƒ‘ãƒ‰ãƒ«è¡çª
      if (hitPaddle(ball, player) && ball.vx < 0) {
        const zone = checkSpecialZone(ball.y, player);
        if (zone) {
          // ç‰¹æ®Šãƒ’ãƒƒãƒˆï¼é€Ÿåº¦ãƒ–ãƒ¼ã‚¹ãƒˆï¼‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
          preboostSpeed = Math.abs(ball.vx); // ãƒ–ãƒ¼ã‚¹ãƒˆå‰ã®é€Ÿåº¦ã‚’ä¿å­˜
          ball.vx = preboostSpeed * 1.80;
          ball.vx = clamp(ball.vx, 7, 25);
          spawnHitParticles(ball.x, ball.y, zone);
          paddleFlashTimer = FLASH_DURATION;
          paddleFlashType = zone;
          ballGlowTimer = 30;
          ballGlowType = zone;
          ballScale = 1.45;
        } else {
          ball.vx = Math.abs(ball.vx) * 1.13;
          ball.vx = clamp(ball.vx, 4, 18);
        }
        ball.vy += (ball.y - (player.y + PADDLE_H / 2)) * 0.1;
        ball.vy = clamp(ball.vy, -12, 12);
        ball.x = player.x + PADDLE_W + BALL_R;
      }
      if (hitPaddle(ball, cpu) && ball.vx > 0 && cpuDestroyedTimer === 0) {
        // ç‰¹æ®Šãƒ–ãƒ¼ã‚¹ãƒˆä¸­ãªã‚‰å…ƒã®é€Ÿåº¦ã«æˆ»ã—ã¦ã‹ã‚‰1.13å€ï¼ˆãƒ–ãƒ¼ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼‰
        const wasSpecial = preboostSpeed !== null;
        const baseVx = wasSpecial ? preboostSpeed : Math.abs(ball.vx);
        preboostSpeed = null;
        ball.vx = -(baseVx * 1.13);
        ball.vy += (ball.y - (cpu.y + PADDLE_H / 2)) * 0.1;
        ball.vx = clamp(ball.vx, -18, -4);
        ball.vy = clamp(ball.vy, -12, 12);
        ball.x = cpu.x - BALL_R;

        // ç‰¹æ®Šãƒ’ãƒƒãƒˆã‚’å—ã‘ãŸå ´åˆã¯ãƒ€ãƒ¡ãƒ¼ã‚¸
        if (wasSpecial) {
          cpuHp -= 5;
          cpuDamageFlash = 14;
          if (cpuHp <= 0) {
            cpuDestroyedTimer = 180; // 3ç§’ï¼ˆ60fpsï¼‰
            cpuHp = cpuMaxHp;        // å¾©æ´»å¾Œç”¨ã«HPã‚’ãƒªã‚»ãƒƒãƒˆ
            spawnHitParticles(cpu.x + PADDLE_W / 2, cpu.y + PADDLE_H / 2, 'edge');
            spawnHitParticles(cpu.x + PADDLE_W / 2, cpu.y + PADDLE_H / 2, 'center');
          }
        }
      }

      // å¾—ç‚¹åˆ¤å®š
      if (ball.x - BALL_R < 0) {
        scores.cpu++;
        endPoint('cpu');
      } else if (ball.x + BALL_R > W) {
        scores.player++;
        endPoint('player');
      }
    }

    function hitPaddle(b, p) {
      return b.x - BALL_R < p.x + p.w &&
             b.x + BALL_R > p.x &&
             b.y - BALL_R < p.y + p.h &&
             b.y + BALL_R > p.y;
    }

    function clamp(v, min, max) {
      return Math.max(min, Math.min(max, v));
    }

    function endPoint(scorer) {
      state = 'point';
      if (scores.player >= WIN_SCORE) {
        if (currentStage >= OPPONENTS.length - 1) {
          state = 'allclear';
          initConfetti();
          msg.textContent = 'å…¨ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¶è¦‡ï¼  SPACE ã§ã‚¿ã‚¤ãƒˆãƒ«ã¸';
        } else {
          state = 'stageclear';
          const next = OPPONENTS[currentStage + 1];
          msg.textContent = `STAGE ${currentStage + 1} CLEAR!  æ¬¡ã®ç›¸æ‰‹: ${next.emoji} ${next.name}  SPACE ã§ç¶šã‘ã‚‹`;
        }
      } else if (scores.cpu >= WIN_SCORE) {
        state = 'gameover';
        msg.textContent = `GAME OVER...  SPACE ã§ãƒªãƒˆãƒ©ã‚¤`;
      } else {
        msg.textContent = scorer === 'player' ? 'ãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼' : 'CPUã®ãƒã‚¤ãƒ³ãƒˆ';
        setTimeout(() => {
          resetRound(scorer);
          state = 'playing';
          msg.textContent = '';
        }, 1200);
      }
    }

    // --- ãƒ«ãƒ¼ãƒ— ---
    function loop() {
      update();
      draw();

      // åœæ­¢çŠ¶æ…‹ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
      if (state === 'idle' || state === 'gameover' || state === 'stageclear' || state === 'allclear') {
        drawOverlay();
      }

      // èŠ±å¹é›ªï¼ˆallclear ã®ã¿ï¼‰
      if (state === 'allclear' && confetti.length > 0) {
        updateConfetti();
        drawConfetti();
      }

      // çµæœãƒ†ã‚­ã‚¹ãƒˆ
      if (state === 'stageclear' || state === 'gameover' || state === 'allclear') {
        drawResultText();
      }

      requestAnimationFrame(loop);
    }

    function drawOverlay() {
      ctx.fillStyle = 'rgba(22,33,62,0.55)';
      ctx.fillRect(0, 0, W, H);
    }

    // --- èŠ±å¹é›ª ---
    const CONFETTI_COLORS = ['#ff4757','#ffa502','#2ed573','#1e90ff','#ff6b81','#eccc68','#a29bfe','#fd79a8','#fdcb6e','#00cec9'];

    function initConfetti() {
      confetti = [];
      for (let i = 0; i < 200; i++) {
        confetti.push({
          x: Math.random() * W,
          y: Math.random() * -H,      // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ä¸Šã‹ã‚‰æ•£ã‚‰ã°ã£ãŸä½ç½®ã§ã‚¹ã‚¿ãƒ¼ãƒˆ
          w: 8 + Math.random() * 8,
          h: 4 + Math.random() * 6,
          vx: (Math.random() - 0.5) * 2.5,
          vy: 2.5 + Math.random() * 3.5,
          angle: Math.random() * Math.PI * 2,
          spin: (Math.random() - 0.5) * 0.18,
          color: CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)],
        });
      }
    }

    function updateConfetti() {
      confetti.forEach(c => {
        c.x += c.vx;
        c.y += c.vy;
        c.angle += c.spin;
        // ç”»é¢ä¸‹ã«å‡ºãŸã‚‰ä¸Šã‹ã‚‰å†ç™»å ´
        if (c.y > H + 20) {
          c.y = -20;
          c.x = Math.random() * W;
        }
      });
    }

    function drawConfetti() {
      confetti.forEach(c => {
        ctx.save();
        ctx.translate(c.x, c.y);
        ctx.rotate(c.angle);
        ctx.fillStyle = c.color;
        ctx.fillRect(-c.w / 2, -c.h / 2, c.w, c.h);
        ctx.restore();
      });
    }

    // --- çµæœãƒ†ã‚­ã‚¹ãƒˆ ---
    function drawResultText() {
      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      if (state === 'stageclear') {
        // You Win! â€” ã‚´ãƒ¼ãƒ«ãƒ‰
        ctx.font = 'bold 72px Arial';
        ctx.shadowBlur = 30;
        ctx.shadowColor = '#ffd700';
        ctx.fillStyle = '#ffd700';
        ctx.fillText('You Win!', W / 2, H / 2 - 30);
      } else if (state === 'gameover') {
        // You Lose. â€” èµ¤
        ctx.font = 'bold 72px Arial';
        ctx.shadowBlur = 30;
        ctx.shadowColor = '#ff4444';
        ctx.fillStyle = '#ff6666';
        ctx.fillText('You Lose.', W / 2, H / 2 - 30);
      } else if (state === 'allclear') {
        // Congratulations! â€” è™¹è‰²ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        ctx.font = 'bold 60px Arial';
        ctx.shadowBlur = 40;
        ctx.shadowColor = '#fff';
        const grad = ctx.createLinearGradient(W / 2 - 280, 0, W / 2 + 280, 0);
        grad.addColorStop(0,   '#ff4757');
        grad.addColorStop(0.2, '#ffa502');
        grad.addColorStop(0.4, '#2ed573');
        grad.addColorStop(0.6, '#1e90ff');
        grad.addColorStop(0.8, '#a29bfe');
        grad.addColorStop(1,   '#fd79a8');
        ctx.fillStyle = grad;
        ctx.fillText('Congratulations!', W / 2, H / 2 - 30);
      }

      ctx.restore();
    }

    // --- ã‚­ãƒ¼å…¥åŠ› ---
    const STAGE_KEYS = { '1':0, '2':1, '3':2, '4':3, '5':4, '6':5, '7':6, '8':7, '9':8, '0':9 };

    document.addEventListener('keydown', e => {
      keys[e.key] = true;
      if (e.key === ' ') {
        e.preventDefault();
        startOrRestart();
      }
      // æ•°å­—ã‚­ãƒ¼ã§ã‚¹ãƒ†ãƒ¼ã‚¸ç›´æ¥é¸æŠ
      if (e.key in STAGE_KEYS) {
        const idx = STAGE_KEYS[e.key];
        currentStage = idx;
        scores = { player: 0, cpu: 0 };
        initCpuHp();
        resetRound(null);
        state = 'playing';
        const opp = OPPONENTS[idx];
        msg.textContent = `STAGE ${idx + 1}: ${opp.emoji} ${opp.name} ã¨å¯¾æˆ¦ï¼`;
        setTimeout(() => { if (state === 'playing') msg.textContent = ''; }, 1800);
      }
    });
    document.addEventListener('keyup', e => { keys[e.key] = false; });

    function startOrRestart() {
      if (state === 'idle') {
        resetRound(null);
        state = 'playing';
        msg.textContent = '';
      } else if (state === 'stageclear') {
        currentStage++;
        scores = { player: 0, cpu: 0 };
        initCpuHp();
        resetRound(null);
        state = 'playing';
        msg.textContent = '';
      } else if (state === 'gameover') {
        // åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ãƒªãƒˆãƒ©ã‚¤
        scores = { player: 0, cpu: 0 };
        resetRound(null);
        state = 'playing';
        msg.textContent = '';
      } else if (state === 'allclear') {
        resetGame();
      }
    }

    // --- ãƒã‚¦ã‚¹è¿½å¾“ ---
    canvas.addEventListener('mousemove', e => {
      const rect = canvas.getBoundingClientRect();
      const scaleX = W / rect.width;
      const scaleY = H / rect.height;
      const mouseX = (e.clientX - rect.left) * scaleX;
      const mouseY = (e.clientY - rect.top) * scaleY;
      // å·¦åŠã‚³ãƒ¼ãƒˆå†…ã«ãƒã‚¦ã‚¹ãŒã‚ã‚‹æ™‚ã ã‘æ›´æ–°ï¼ˆå³åŠã§ã¯æ›´æ–°ã—ãªã„ï¼‰
      if (mouseX <= W / 2) {
        player.x = clamp(mouseX - PADDLE_W / 2, 5, W / 2 - PADDLE_W);
        player.y = clamp(mouseY - PADDLE_H / 2, 0, H - PADDLE_H);
      }
    });

    // --- ã‚¿ãƒƒãƒæ“ä½œ ---
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®ã‚¿ãƒƒãƒ: æŒ‡ã®ä½ç½®ã«ãƒ‘ãƒ‰ãƒ«ã‚’è¿½å¾“
    let touchPos = null;

    function getCanvasPos(touch) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = W / rect.width;
      const scaleY = H / rect.height;
      return {
        x: (touch.clientX - rect.left) * scaleX,
        y: (touch.clientY - rect.top) * scaleY
      };
    }

    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      startOrRestart();
      touchPos = getCanvasPos(e.touches[0]);
    }, { passive: false });

    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      touchPos = getCanvasPos(e.touches[0]);
    }, { passive: false });

    canvas.addEventListener('touchend', e => {
      e.preventDefault();
      touchPos = null;
    }, { passive: false });

    // â–²â–¼ ãƒœã‚¿ãƒ³ï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ï¼‰
    const btnUp   = document.getElementById('btn-up');
    const btnDown = document.getElementById('btn-down');

    function addButtonTouch(btn, keyName) {
      btn.addEventListener('touchstart', e => {
        e.preventDefault();
        keys[keyName] = true;
        startOrRestart();
      }, { passive: false });
      btn.addEventListener('touchend', e => {
        e.preventDefault();
        keys[keyName] = false;
      }, { passive: false });
      btn.addEventListener('mousedown', () => { keys[keyName] = true; startOrRestart(); });
      btn.addEventListener('mouseup',   () => { keys[keyName] = false; });
    }
    addButtonTouch(btnUp,   'ArrowUp');
    addButtonTouch(btnDown, 'ArrowDown');

    // --- èµ·å‹• ---
    resetGame();
    loop();
  </script>
</body>
</html>
